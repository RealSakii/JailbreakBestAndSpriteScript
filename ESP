--// ESP BOX (WORKING VERSION)

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Camera = workspace.CurrentCamera
local LocalPlayer = Players.LocalPlayer

local ESP = {}
local ESP_ENABLED = false
local ESP_COLOR = Color3.fromRGB(0,170,255)

-- Create ESP
local function CreateESP(player)
	if player == LocalPlayer or ESP[player] then return end

	local box = Drawing.new("Square")
	box.Color = ESP_COLOR
	box.Thickness = 2
	box.Filled = false
	box.Visible = false

	local name = Drawing.new("Text")
	name.Color = ESP_COLOR
	name.Size = 14
	name.Center = true
	name.Outline = true
	name.Font = 2
	name.Visible = false

	local distText = Drawing.new("Text")
	distText.Color = ESP_COLOR
	distText.Size = 13
	distText.Center = true
	distText.Outline = true
	distText.Font = 2
	distText.Visible = false

	local hpBg = Drawing.new("Square")
	hpBg.Color = Color3.fromRGB(40,40,40)
	hpBg.Filled = true
	hpBg.Visible = false

	local hp = Drawing.new("Square")
	hp.Color = Color3.fromRGB(0,255,0)
	hp.Filled = true
	hp.Visible = false

	ESP[player] = {box, name, distText, hpBg, hp}
end

-- Remove ESP
local function RemoveESP(player)
	if ESP[player] then
		for _, d in ipairs(ESP[player]) do
			pcall(function() d:Remove() end)
		end
		ESP[player] = nil
	end
end

-- Toggle (P)
UserInputService.InputBegan:Connect(function(i,gp)
	if gp then return end
	if i.KeyCode == Enum.KeyCode.P then
		ESP_ENABLED = not ESP_ENABLED
	end
end)

-- Auto create
RunService.Heartbeat:Connect(function()
	for _, p in ipairs(Players:GetPlayers()) do
		if not ESP[p] and p ~= LocalPlayer then
			CreateESP(p)
		end
	end
end)

-- Update
RunService.RenderStepped:Connect(function()
	for player, d in pairs(ESP) do
		local box,name,distText,hpBg,hp = unpack(d)

		if not ESP_ENABLED then
			box.Visible=false name.Visible=false distText.Visible=false hpBg.Visible=false hp.Visible=false
			continue
		end

		local char = player.Character
		local hrp = char and char:FindFirstChild("HumanoidRootPart")
		local hum = char and char:FindFirstChildOfClass("Humanoid")
		local lhrp = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")

		if hrp and hum and hum.Health>0 and lhrp then
			local pos,onScreen = Camera:WorldToViewportPoint(hrp.Position)
			if onScreen then
				local scale = math.clamp(3000/pos.Z,25,300)
				local size = Vector2.new(scale,scale*1.5)

				box.Size=size
				box.Position=Vector2.new(pos.X-size.X/2,pos.Y-size.Y/2)
				box.Visible=true

				name.Text=player.Name
				name.Position=Vector2.new(pos.X,pos.Y-size.Y/2-26)
				name.Visible=true

				local dist = math.floor((lhrp.Position-hrp.Position).Magnitude)
				distText.Text=dist.." m"
				distText.Position=Vector2.new(pos.X,pos.Y+size.Y/2+2)
				distText.Visible=true

				local hpPercent = hum.Health/hum.MaxHealth
				hpBg.Size=Vector2.new(4,size.Y)
				hpBg.Position=Vector2.new(pos.X-size.X/2-8,pos.Y-size.Y/2)
				hpBg.Visible=true

				hp.Size=Vector2.new(4,size.Y*hpPercent)
				hp.Position=Vector2.new(pos.X-size.X/2-8,pos.Y+size.Y/2-hp.Size.Y)
				hp.Visible=true
			else
				box.Visible=false name.Visible=false distText.Visible=false hpBg.Visible=false hp.Visible=false
			end
		else
			box.Visible=false name.Visible=false distText.Visible=false hpBg.Visible=false hp.Visible=false
		end
	end
end)

Players.PlayerRemoving:Connect(RemoveESP)

